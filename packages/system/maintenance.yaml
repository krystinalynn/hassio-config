################################################
#                                              #
# This package creates a device that allows me #
# to set a boolean to show the system in       #
# "Maintenance Mode", and manage backing up,   #
# upgrading and pulling config from Github     #
#                                              #
################################################


homeassistant:
  customize_glob:
    weblink.*:
      icon: mdi:web

  customize:
    script.zwave_on:
      icon: mdi:check-circle-outline
      custom_text: Z-Wave On

    script.zwave_off:
      icon: mdi:close-octagon-outline
      custom_text: Z-Wave Off

    script.zwave_include:
      icon: mdi:plus-circle-outline
      custom_text: "Add New Device (Secure)"
    
    script.github_pull:
      icon: mdi:github-box
      custom_text: Github pull
    
    script.restart_ha:
      icon: mdi:home-assistant
      custom_text: Restart Home Assistant

input_boolean:
  maintenance_mode:
    name: Maintenance mode
    icon: mdi:auto-fix

group:
  maintenance:
    name: Maintenance
    control: hidden
    entities:
      - input_boolean.maintenance_mode
      - weblink.github
      - weblink.onedrive
      - script.github_pull
      - script.restart_ha

  Z-Wave:
    control: hidden
    entities:
      - script.zwave_on
      - script.zwave_off
      - script.zwave_include    


alert:
  maintenance_mode_alert:
    name: Maintenance Mode has been on for a long time
    done_message: Maintenance Mode de-activated
    entity_id: input_boolean.maintenance_mode
    repeat:
      - 60
    skip_first: true
    notifiers:
      - matt

script:
  zwave_on:
    alias: Z-Wave Start Network
    sequence:
      - service: zwave.start_network

  zwave_off:
    alias: Z-Wave Stop Network
    sequence:
      - service: zwave.stop_network

  zwave_include:
    alias: Z-Wave Add Node (Secure)
    sequence:
      - service: zwave.add_node_secure
    
  github_pull:
      alias: Github Pull
      sequence:
        - service: homeassistant.turn_on
          data:
            entity_id: input_boolean.maintenance_mode
        - service: hassio.addon_restart
          data:
            addon: core_git_pull
  
  restart_ha:
    alias: Restart HA
    sequence:
      - service: homeassistant.restart

automation:
  - alias: Let's Encrypt - Renewal
    trigger:
      - platform: time
        at: '00:00:00'
    action:
      - service: hassio.addon_stop
        data:
          addon: core_nginx_proxy
      - service: hassio.addon_restart
        data:
          addon: core_letsencrypt
      - delay: '00:01:00'
      - service: hassio.addon_stop
        data:
          addon: core_letsencrypt
      - service: hassio.addon_start
        data:
          addon: core_nginx_proxy
  
  - alias: Daily snapshot
    trigger:
      - platform: time
        at: '00:30:00'
    action:
      - service: hassio.snapshot_full
        data_template:
          name: AutoBackup-Daily-{{ now().strftime ('%d-%m-%y') }}
          password: !secret snapshot_password