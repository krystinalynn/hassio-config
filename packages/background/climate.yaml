####################################################
#                                                  #
# This package automates the Nest HVAC controls    #
#                                                  #
# Automates:                                       #
#   - away mode on house empty                     #
#   - eco mode when warm weather                   #
# DEPENDS ON Occupancy & Environment               #
#                                                  #
####################################################

nest:
  client_id: !secret nest_clientid
  client_secret: !secret nest_clientsecret

climate:
  platform: nest

sensor:
  - platform: mqtt
    name: Hallway Temperature
    state_topic: smartthings/Hallway Motion Sensor/temperature/state
    device_class: temperature
    retain: true


input_number:
  outside_temp_offset:
    name: Outside Temperature Offset
    min: 0
    max: 10
    step: 1

binary_sensor:
  - platform: template
    sensors:
      warmer_than_setpoint:
        friendly_name: Outside warmer than heat setpoint
        value_template: >-
          {{ (states.sensor.met_office_temperature.state | float)
            + (states.input_number.outside_temp_offset.state | int)
            >= states.sensor.hallway_thermostat_target.state | float }}

input_boolean:
  ha_owns_eco_mode:
    name: Home Assistant Owns Nest Eco Mode
    icon: mdi:leaf


automation:
  - alias: Climate - away mode on
    initial_state: on
    trigger:
      platform: state
      entity_id: input_boolean.away_mode
      to: 'on'
      for:
        minutes: 5
    action:
      - service: climate.set_away_mode
        data:
          entity_id: climate.hallway
          away_mode: true

  - alias: Climate - away mode off
    initial_state: on
    trigger:
      platform: state
      entity_id: input_boolean.away_mode
      to: 'off'
    action:
      - service: climate.set_away_mode
        data:
          entity_id: climate.hallway
          away_mode: false

  - alias: Climate - Enable eco mode when warm weather
    initial_state: on
    trigger:
      - platform: state
        entity_id: binary_sensor.warmer_than_setpoint
      - platform: state
        entity_id: sensor.hallway_thermostat_operation_mode
        to: 'heat'
    action:
      - service: climate.set_operation_mode
        data_template:
          entity_id: climate.hallway
          operation_mode: >-
            {%- if ((states.binary_sensor.warmer_than_setpoint.state == 'on')
              and
            (states.climate.hallway.attributes.operation_mode == 'heat')) -%}
              'eco'
            {%- elif ((states.binary_sensor.warmer_than_setpoint.state == 'off')
              and
            (states.climate.hallway.attributes.operation_mode == 'eco')
              and
            (states.input_boolean.ha_owns_eco_mode.state == 'on')) -%}
              'heat'
            {%- endif -%}
      - service_template: >-
        {%- if ((states.binary_sensor.warmer_than_setpoint.state == 'on')
          and
        (states.climate.hallway.attributes.operation_mode == 'heat')) -%}
          homeassistant.turn_on
        {%- elif ((states.binary_sensor.warmer_than_setpoint.state == 'off')
          and
        (states.climate.hallway.attributes.operation_mode == 'eco')
          and
        (states.input_boolean.ha_owns_eco_mode.state == 'on')) -%}
          homeassistant.turn_off
        {%- endif -%}
      entity_id: input_boolean.ha_owns_eco_mode